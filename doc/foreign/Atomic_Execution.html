<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>5.8&nbsp;Atomic Execution</title><link rel="stylesheet" type="text/css" href="../scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="../racket.css" title="default"/><link rel="stylesheet" type="text/css" href="../manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="../manual-racket.css" title="default"/><link rel="stylesheet" type="text/css" href="../doc-site.css" title="default"/><script type="text/javascript" src="../scribble-common.js"></script><script type="text/javascript" src="../manual-racket.js"></script><script type="text/javascript" src="../doc-site.js"></script><script type="text/javascript" src="../local-redirect/local-redirect.js"></script><script type="text/javascript" src="../local-redirect/local-user-redirect.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="doc-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">The Racket Foreign Interface</a></td></tr></table></div><div class="tocviewsublisttop" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="intro.html" class="tocviewlink" data-pltdoc="x">Overview</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="Loading_Foreign_Libraries.html" class="tocviewlink" data-pltdoc="x">Loading Foreign Libraries</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="types.html" class="tocviewlink" data-pltdoc="x">C Types</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="foreign_pointer-funcs.html" class="tocviewlink" data-pltdoc="x">Pointer Functions</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="Derived_Utilities.html" class="tocviewselflink" data-pltdoc="x">Derived Utilities</a></td></tr><tr><td align="right">6&nbsp;</td><td><a href="Miscellaneous_Support.html" class="tocviewlink" data-pltdoc="x">Miscellaneous Support</a></td></tr><tr><td align="right">7&nbsp;</td><td><a href="foreign_c-only.html" class="tocviewlink" data-pltdoc="x">Unexported Primitive Functions</a></td></tr><tr><td align="right"></td><td><a href="doc-bibliography.html" class="tocviewlink" data-pltdoc="x">Bibliography</a></td></tr><tr><td align="right"></td><td><a href="doc-index.html" class="tocviewlink" data-pltdoc="x">Index</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9660;</a></td><td>5&nbsp;</td><td><a href="Derived_Utilities.html" class="tocviewlink" data-pltdoc="x">Derived Utilities</a></td></tr></table><div class="tocviewsublistbottom" style="display: block;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">5.1&nbsp;</td><td><a href="homogeneous-vectors.html" class="tocviewlink" data-pltdoc="x">Safe Homogenous Vectors</a></td></tr><tr><td align="right">5.2&nbsp;</td><td><a href="foreign_cvector.html" class="tocviewlink" data-pltdoc="x">Safe C Vectors</a></td></tr><tr><td align="right">5.3&nbsp;</td><td><a href="foreign_tagged-pointers.html" class="tocviewlink" data-pltdoc="x">Tagged C Pointer Types</a></td></tr><tr><td align="right">5.4&nbsp;</td><td><a href="serialize-struct.html" class="tocviewlink" data-pltdoc="x">Serializable C Struct Types</a></td></tr><tr><td align="right">5.5&nbsp;</td><td><a href="Defining_Bindings.html" class="tocviewlink" data-pltdoc="x">Defining Bindings</a></td></tr><tr><td align="right">5.6&nbsp;</td><td><a href="Allocation_and_Finalization.html" class="tocviewlink" data-pltdoc="x">Allocation and Finalization</a></td></tr><tr><td align="right">5.7&nbsp;</td><td><a href="Custodian_Shutdown_Registration.html" class="tocviewlink" data-pltdoc="x">Custodian Shutdown Registration</a></td></tr><tr><td align="right">5.8&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Atomic Execution</a></td></tr><tr><td align="right">5.9&nbsp;</td><td><a href="Speculatively_Atomic_Execution.html" class="tocviewlink" data-pltdoc="x">Speculatively Atomic Execution</a></td></tr><tr><td align="right">5.10&nbsp;</td><td><a href="Thread_Scheduling.html" class="tocviewlink" data-pltdoc="x">Thread Scheduling</a></td></tr><tr><td align="right">5.11&nbsp;</td><td><a href="Ports.html" class="tocviewlink" data-pltdoc="x">Ports</a></td></tr><tr><td align="right">5.12&nbsp;</td><td><a href="unsafe-global.html" class="tocviewlink" data-pltdoc="x">Process-<wbr></wbr>Wide and Place-<wbr></wbr>Wide Registration</a></td></tr><tr><td align="right">5.13&nbsp;</td><td><a href="Operating_System_Threads.html" class="tocviewlink" data-pltdoc="x">Operating System Threads</a></td></tr><tr><td align="right">5.14&nbsp;</td><td><a href="Garbage_Collection_Callbacks.html" class="tocviewlink" data-pltdoc="x">Garbage Collection Callbacks</a></td></tr><tr><td align="right">5.15&nbsp;</td><td><a href="Objective-C_FFI.html" class="tocviewlink" data-pltdoc="x">Objective-<wbr></wbr>C FFI</a></td></tr><tr><td align="right">5.16&nbsp;</td><td><a href="ns.html" class="tocviewlink" data-pltdoc="x">Cocoa Foundation</a></td></tr><tr><td align="right">5.17&nbsp;</td><td><a href="com.html" class="tocviewlink" data-pltdoc="x">COM (Common Object Model)</a></td></tr><tr><td align="right">5.18&nbsp;</td><td><a href="file-security-guard-checks.html" class="tocviewlink" data-pltdoc="x">File Security-<wbr></wbr>Guard Checks</a></td></tr><tr><td align="right">5.19&nbsp;</td><td><a href="winapi.html" class="tocviewlink" data-pltdoc="x">Windows API Helpers</a></td></tr></table></div></div></div><div class="tocsub"><div class="tocsubtitle">在本页中：</div><table class="tocsublist" cellspacing="0"><tr><td><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._start-atomic%29%29" class="tocsublink" data-pltdoc="x"><span class="RktSym"><span class="RktValLink">start-<wbr></wbr>atomic</span></span></a></td></tr><tr><td><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._end-atomic%29%29" class="tocsublink" data-pltdoc="x"><span class="RktSym"><span class="RktValLink">end-<wbr></wbr>atomic</span></span></a></td></tr><tr><td><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._start-breakable-atomic%29%29" class="tocsublink" data-pltdoc="x"><span class="RktSym"><span class="RktValLink">start-<wbr></wbr>breakable-<wbr></wbr>atomic</span></span></a></td></tr><tr><td><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._end-breakable-atomic%29%29" class="tocsublink" data-pltdoc="x"><span class="RktSym"><span class="RktValLink">end-<wbr></wbr>breakable-<wbr></wbr>atomic</span></span></a></td></tr><tr><td><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._call-as-atomic%29%29" class="tocsublink" data-pltdoc="x"><span class="RktSym"><span class="RktValLink">call-<wbr></wbr>as-<wbr></wbr>atomic</span></span></a></td></tr><tr><td><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._call-as-nonatomic%29%29" class="tocsublink" data-pltdoc="x"><span class="RktSym"><span class="RktValLink">call-<wbr></wbr>as-<wbr></wbr>nonatomic</span></span></a></td></tr><tr><td><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._in-atomic-mode~3f%29%29" class="tocsublink" data-pltdoc="x"><span class="RktSym"><span class="RktValLink">in-<wbr></wbr>atomic-<wbr></wbr>mode?</span></span></a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="navsettop"><span class="navleft"><form class="searchform"><input class="searchbox" style="color: #888;" type="text" value="…搜索手册…" title="输入搜索字符串以搜索手册" onkeypress="return DoSearchKey(event, this, &quot;7.0.0.18&quot;, &quot;../&quot;);" onfocus="this.style.color=&quot;black&quot;; this.style.textAlign=&quot;left&quot;; if (this.value == &quot;…搜索手册…&quot;) this.value=&quot;&quot;;" onblur="if (this.value.match(/^ *$/)) { this.style.color=&quot;#888&quot;; this.style.textAlign=&quot;center&quot;; this.value=&quot;…搜索手册…&quot;; }"/></form>&nbsp;&nbsp;<a href="../index.html" title="上至文档的顶层" data-pltdoc="x" onclick="return GotoPLTRoot(&quot;7.0.0.18&quot;);">&#39030;&#23618;</a></span><span class="navright">&nbsp;&nbsp;<a href="Custodian_Shutdown_Registration.html" title="后退至&quot;5.7 Custodian Shutdown Registration&quot;" data-pltdoc="x">&larr; &#21069;&#19968;&#39029;</a>&nbsp;&nbsp;<a href="Derived_Utilities.html" title="上至&quot;5 Derived Utilities&quot;" data-pltdoc="x">&#19978;&#19968;&#23618;</a>&nbsp;&nbsp;<a href="Speculatively_Atomic_Execution.html" title="前进至&quot;5.9 Speculatively Atomic Execution&quot;" data-pltdoc="x">&#21518;&#19968;&#39029; &rarr;</a></span>&nbsp;</div><h4 x-source-module="(lib &quot;scribblings/foreign/foreign.scrbl&quot;)" x-source-pkg="racket-doc" x-part-tag="&quot;Atomic_Execution&quot;">5.8<tt>&nbsp;</tt><a name="(part._.Atomic_.Execution)"></a><a name="(mod-path._ffi/unsafe/atomic)"></a>Atomic Execution</h4><p><table cellspacing="0" cellpadding="0" class="defmodule"><tr><td align="left"><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=require.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._require%2529%2529&amp;version=7.0.0.18" class="RktStxLink Sq" data-pltdoc="x">require</a></span><span class="stt"> </span><a href="" class="RktModLink" data-pltdoc="x"><span class="RktSym">ffi/unsafe/atomic</span></a><span class="RktPn">)</span></td><td align="right"><span class="RpackageSpec"><span class="Smaller">&nbsp;package&#65306;</span> <a href="https://pkgs.racket-lang.org/package/base" title="使用“raco pkg install base”安装此包"><span class="stt">base</span></a></span></td></tr></table></p><p><a name="(tech._atomic._mode)"></a><span style="font-family: 楷体">Atomic mode</span> evaluates a Racket expression without switching
among Racket threads and with limited support for events. An atomic
computation in this sense is <span style="font-family: 楷体">not</span> atomic with respect to other
<a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=places.html%23%2528tech._place%2529&amp;version=7.0.0.18" class="techoutside Sq" data-pltdoc="x"><span class="techinside">places</span></a>, but only to other <a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=eval-model.html%23%2528tech._thread%2529&amp;version=7.0.0.18" class="techoutside Sq" data-pltdoc="x"><span class="techinside">threads</span></a> within a place.</p><p><a name="(elem._atomic-unsafe)"></a>Atomic mode is <span style="font-weight: bold">unsafe</span>, because the
Racket scheduler is not able to operate while execution is in atomic
mode; the scheduler cannot switch threads or poll certain kinds of
events, which can lead to deadlock or starvation of other threads.
Beware that many operations can involve such synchronization, such as
writing to an output port. Even if an output target is known to be
free of synchronization, beware that values can have arbitrary
printing procedures attached through <span class="RktSym"><a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=Printer_Extension.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._prop%7E3acustom-write%2529%2529&amp;version=7.0.0.18" class="RktValLink Sq" data-pltdoc="x">prop:custom-write</a></span>.
Successful use of atomic mode requires a detailed knowledge of any
implementation that might be reached during atomic mode to ensure that
it terminates and does not involve synchronization.</p><p><div class="SIntrapara"><blockquote class="SVInsetFlow"><table cellspacing="0" cellpadding="0" class="boxed RBoxed"><tr><td><table cellspacing="0" cellpadding="0" class="together"><tr><td><blockquote class="SubFlow"><div class="RBackgroundLabel SIEHidden"><div class="RBackgroundLabelInner"><p>&#20989;&#25968;</p></div></div><p class="RForeground"><span class="RktPn">(</span><a name="(def._((lib._ffi/unsafe/atomic..rkt)._start-atomic))"></a><span title="提供自：ffi/unsafe/atomic | 包：base"><span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._start-atomic%29%29" class="RktValDef RktValLink" data-pltdoc="x">start-atomic</a></span></span><span class="RktPn"></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span>&rarr;<span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=void.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._void%7E3f%2529%2529&amp;version=7.0.0.18" class="RktValLink Sq" data-pltdoc="x">void?</a></span></p></blockquote></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="together"><tr><td><blockquote class="SubFlow"><div class="RBackgroundLabel SIEHidden"><div class="RBackgroundLabelInner"><p>&#20989;&#25968;</p></div></div><p class="RForeground"><span class="RktPn">(</span><a name="(def._((lib._ffi/unsafe/atomic..rkt)._end-atomic))"></a><span title="提供自：ffi/unsafe/atomic | 包：base"><span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._end-atomic%29%29" class="RktValDef RktValLink" data-pltdoc="x">end-atomic</a></span></span><span class="RktPn"></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span>&rarr;<span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=void.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._void%7E3f%2529%2529&amp;version=7.0.0.18" class="RktValLink Sq" data-pltdoc="x">void?</a></span></p></blockquote></td></tr></table></td></tr></table></blockquote></div><div class="SIntrapara">Disables/re-enables context switches at the level of Racket threads,
and also suspends/resumes delivery of break exceptions (independent of the
result of <span class="RktSym"><a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=breakhandler.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._break-enabled%2529%2529&amp;version=7.0.0.18" class="RktValLink Sq" data-pltdoc="x">break-enabled</a></span>). Calls to <span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._start-atomic%29%29" class="RktValLink" data-pltdoc="x">start-atomic</a></span> and
<span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._end-atomic%29%29" class="RktValLink" data-pltdoc="x">end-atomic</a></span> can be nested.</div></p><p>Note that pairing <span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._start-atomic%29%29" class="RktValLink" data-pltdoc="x">start-atomic</a></span> and <span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._end-atomic%29%29" class="RktValLink" data-pltdoc="x">end-atomic</a></span> with
<span class="RktSym"><a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=cont.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._dynamic-wind%2529%2529&amp;version=7.0.0.18" class="RktValLink Sq" data-pltdoc="x">dynamic-wind</a></span> is useful only when</p><ul><li><p>the current <a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=eval-model.html%23%2528tech._exception._handler%2529&amp;version=7.0.0.18" class="techoutside Sq" data-pltdoc="x"><span class="techinside">exception handler</span></a> is
known to safely escape atomic mode, or else all possible
escapes are through known continuation jumps or aborts (because
breaks are disabled and no other exceptions are possible) that
escape safely; and</p></li><li><p>exception constructions, if any, avoid printing values in the
exception message, or else the <a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=exns.html%23%2528tech._error._value._conversion._handler%2529&amp;version=7.0.0.18" class="techoutside Sq" data-pltdoc="x"><span class="techinside">error value conversion handler</span></a> is always used
and known to be safe for atomic mode.</p></li></ul><p>Using <span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._call-as-atomic%29%29" class="RktValLink" data-pltdoc="x">call-as-atomic</a></span> is somewhat safer than using
<span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._start-atomic%29%29" class="RktValLink" data-pltdoc="x">start-atomic</a></span> and <span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._end-atomic%29%29" class="RktValLink" data-pltdoc="x">end-atomic</a></span>, because
<span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._call-as-atomic%29%29" class="RktValLink" data-pltdoc="x">call-as-atomic</a></span> catches exceptions and re-raises them after
exiting atomic mode, and it wraps any call to the error value
conversion handler with <span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._call-as-nonatomic%29%29" class="RktValLink" data-pltdoc="x">call-as-nonatomic</a></span>. The latter is safe
for a particular atomic region, however, only if the region can be
safely interrupted by a non-atomic exception construction.</p><p>See also the caveat that <a href="#%28elem._atomic-unsafe%29" data-pltdoc="x">atomic mode is unsafe</a>.</p><p><div class="SIntrapara"><blockquote class="SVInsetFlow"><table cellspacing="0" cellpadding="0" class="boxed RBoxed"><tr><td><table cellspacing="0" cellpadding="0" class="together"><tr><td><blockquote class="SubFlow"><div class="RBackgroundLabel SIEHidden"><div class="RBackgroundLabelInner"><p>&#20989;&#25968;</p></div></div><p class="RForeground"><span class="RktPn">(</span><a name="(def._((lib._ffi/unsafe/atomic..rkt)._start-breakable-atomic))"></a><span title="提供自：ffi/unsafe/atomic | 包：base"><span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._start-breakable-atomic%29%29" class="RktValDef RktValLink" data-pltdoc="x">start-breakable-atomic</a></span></span><span class="RktPn"></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span>&rarr;<span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=void.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._void%7E3f%2529%2529&amp;version=7.0.0.18" class="RktValLink Sq" data-pltdoc="x">void?</a></span></p></blockquote></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="together"><tr><td><blockquote class="SubFlow"><div class="RBackgroundLabel SIEHidden"><div class="RBackgroundLabelInner"><p>&#20989;&#25968;</p></div></div><p class="RForeground"><span class="RktPn">(</span><a name="(def._((lib._ffi/unsafe/atomic..rkt)._end-breakable-atomic))"></a><span title="提供自：ffi/unsafe/atomic | 包：base"><span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._end-breakable-atomic%29%29" class="RktValDef RktValLink" data-pltdoc="x">end-breakable-atomic</a></span></span><span class="RktPn"></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span>&rarr;<span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=void.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._void%7E3f%2529%2529&amp;version=7.0.0.18" class="RktValLink Sq" data-pltdoc="x">void?</a></span></p></blockquote></td></tr></table></td></tr></table></blockquote></div><div class="SIntrapara">Like <span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._start-atomic%29%29" class="RktValLink" data-pltdoc="x">start-atomic</a></span> and <span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._end-atomic%29%29" class="RktValLink" data-pltdoc="x">end-atomic</a></span>, but the delivery
of break exceptions is not suspended.</div></p><p>These functions are not significantly faster than
<span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._start-atomic%29%29" class="RktValLink" data-pltdoc="x">start-atomic</a></span> and <span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._end-atomic%29%29" class="RktValLink" data-pltdoc="x">end-atomic</a></span>, so they provide no
benefit in a context where breaks are disabled.</p><p><div class="SIntrapara"><blockquote class="SVInsetFlow"><table cellspacing="0" cellpadding="0" class="boxed RBoxed"><tr><td><blockquote class="SubFlow"><div class="RBackgroundLabel SIEHidden"><div class="RBackgroundLabelInner"><p>&#20989;&#25968;</p></div></div><p class="RForeground"><span class="RktPn">(</span><a name="(def._((lib._ffi/unsafe/atomic..rkt)._call-as-atomic))"></a><span title="提供自：ffi/unsafe/atomic | 包：base"><span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._call-as-atomic%29%29" class="RktValDef RktValLink" data-pltdoc="x">call-as-atomic</a></span></span><span class="hspace">&nbsp;</span><span class="RktVar">thunk</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span>&rarr;<span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=data-structure-contracts.html%23%2528form._%2528%2528lib._racket%252Fcontract%252Fprivate%252Fmisc..rkt%2529._any%2529%2529&amp;version=7.0.0.18" class="RktStxLink Sq" data-pltdoc="x">any</a></span></p></blockquote></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">thunk</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=function-contracts.html%23%2528form._%2528%2528lib._racket%252Fcontract%252Fbase..rkt%2529._-%7E3e%2529%2529&amp;version=7.0.0.18" class="RktStxLink Sq" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=data-structure-contracts.html%23%2528form._%2528%2528lib._racket%252Fcontract%252Fprivate%252Fmisc..rkt%2529._any%2529%2529&amp;version=7.0.0.18" class="RktStxLink Sq" data-pltdoc="x">any</a></span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara">Calls <span class="RktVar">thunk</span> in atomic mode, where <span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._call-as-nonatomic%29%29" class="RktValLink" data-pltdoc="x">call-as-nonatomic</a></span>
can be used during the dynamic extent of the call to revert to
non-atomic mode for a nested computation.</div></p><p>When <span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._call-as-atomic%29%29" class="RktValLink" data-pltdoc="x">call-as-atomic</a></span> is used in the dynamic extent of
<span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._call-as-atomic%29%29" class="RktValLink" data-pltdoc="x">call-as-atomic</a></span>, then <span class="RktVar">thunk</span> is called directly as a
non-tail call.</p><p>If <span class="RktVar">thunk</span> raises an exception, the exception is caught and
re-raised after exiting atomic mode. Any call to the current
<a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=exns.html%23%2528tech._error._value._conversion._handler%2529&amp;version=7.0.0.18" class="techoutside Sq" data-pltdoc="x"><span class="techinside">error value conversion handler</span></a> is
effectively wrapped with <span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._call-as-nonatomic%29%29" class="RktValLink" data-pltdoc="x">call-as-nonatomic</a></span>.</p><p>See also the caveat that <a href="#%28elem._atomic-unsafe%29" data-pltdoc="x">atomic mode is unsafe</a>.</p><p><div class="SIntrapara"><blockquote class="SVInsetFlow"><table cellspacing="0" cellpadding="0" class="boxed RBoxed"><tr><td><blockquote class="SubFlow"><div class="RBackgroundLabel SIEHidden"><div class="RBackgroundLabelInner"><p>&#20989;&#25968;</p></div></div><p class="RForeground"><span class="RktPn">(</span><a name="(def._((lib._ffi/unsafe/atomic..rkt)._call-as-nonatomic))"></a><span title="提供自：ffi/unsafe/atomic | 包：base"><span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._call-as-nonatomic%29%29" class="RktValDef RktValLink" data-pltdoc="x">call-as-nonatomic</a></span></span><span class="hspace">&nbsp;</span><span class="RktVar">thunk</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span>&rarr;<span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=data-structure-contracts.html%23%2528form._%2528%2528lib._racket%252Fcontract%252Fprivate%252Fmisc..rkt%2529._any%2529%2529&amp;version=7.0.0.18" class="RktStxLink Sq" data-pltdoc="x">any</a></span></p></blockquote></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">thunk</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=function-contracts.html%23%2528form._%2528%2528lib._racket%252Fcontract%252Fbase..rkt%2529._-%7E3e%2529%2529&amp;version=7.0.0.18" class="RktStxLink Sq" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=data-structure-contracts.html%23%2528form._%2528%2528lib._racket%252Fcontract%252Fprivate%252Fmisc..rkt%2529._any%2529%2529&amp;version=7.0.0.18" class="RktStxLink Sq" data-pltdoc="x">any</a></span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara">Within the dynamic extent of a call to <span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._call-as-atomic%29%29" class="RktValLink" data-pltdoc="x">call-as-atomic</a></span>, calls
<span class="RktVar">thunk</span> in non-atomic mode. Beware that the current thread may
be suspended or terminated by other threads during the execution of
<span class="RktVar">thunk</span>.</div></p><p>When used not in the dynamic extent of a call to
<span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._call-as-atomic%29%29" class="RktValLink" data-pltdoc="x">call-as-atomic</a></span>, <span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._call-as-nonatomic%29%29" class="RktValLink" data-pltdoc="x">call-as-nonatomic</a></span> raises
<span class="RktSym"><a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=exns.html%23%2528def._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._exn%7E3afail%7E3acontract%2529%2529&amp;version=7.0.0.18" class="RktValLink Sq" data-pltdoc="x">exn:fail:contract</a></span>.</p><p><div class="SIntrapara"><blockquote class="SVInsetFlow"><table cellspacing="0" cellpadding="0" class="boxed RBoxed"><tr><td><blockquote class="SubFlow"><div class="RBackgroundLabel SIEHidden"><div class="RBackgroundLabelInner"><p>&#20989;&#25968;</p></div></div><p class="RForeground"><span class="RktPn">(</span><a name="(def._((lib._ffi/unsafe/atomic..rkt)._in-atomic-mode~3f))"></a><span title="提供自：ffi/unsafe/atomic | 包：base"><span class="RktSym"><a href="#%28def._%28%28lib._ffi%2Funsafe%2Fatomic..rkt%29._in-atomic-mode~3f%29%29" class="RktValDef RktValLink" data-pltdoc="x">in-atomic-mode?</a></span></span><span class="RktPn"></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span>&rarr;<span class="hspace">&nbsp;</span><span class="RktSym"><a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=booleans.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._boolean%7E3f%2529%2529&amp;version=7.0.0.18" class="RktValLink Sq" data-pltdoc="x">boolean?</a></span></p></blockquote></td></tr></table></blockquote></div><div class="SIntrapara">Returns <span class="RktVal">#t</span> when in <a href="#%28tech._atomic._mode%29" class="techoutside" data-pltdoc="x"><span class="techinside">atomic mode</span></a> (within the current
<a href="http://docs.racket-lang.org/local-redirect/index.html?doc=reference&amp;rel=places.html%23%2528tech._place%2529&amp;version=7.0.0.18" class="techoutside Sq" data-pltdoc="x"><span class="techinside">place</span></a>), <span class="RktVal">#f</span> otherwise.</div></p><div class="navsetbottom"><span class="navleft"><form class="searchform"><input class="searchbox" style="color: #888;" type="text" value="…搜索手册…" title="输入搜索字符串以搜索手册" onkeypress="return DoSearchKey(event, this, &quot;7.0.0.18&quot;, &quot;../&quot;);" onfocus="this.style.color=&quot;black&quot;; this.style.textAlign=&quot;left&quot;; if (this.value == &quot;…搜索手册…&quot;) this.value=&quot;&quot;;" onblur="if (this.value.match(/^ *$/)) { this.style.color=&quot;#888&quot;; this.style.textAlign=&quot;center&quot;; this.value=&quot;…搜索手册…&quot;; }"/></form>&nbsp;&nbsp;<a href="../index.html" title="上至文档的顶层" data-pltdoc="x" onclick="return GotoPLTRoot(&quot;7.0.0.18&quot;);">&#39030;&#23618;</a></span><span class="navright">&nbsp;&nbsp;<a href="Custodian_Shutdown_Registration.html" title="后退至&quot;5.7 Custodian Shutdown Registration&quot;" data-pltdoc="x">&larr; &#21069;&#19968;&#39029;</a>&nbsp;&nbsp;<a href="Derived_Utilities.html" title="上至&quot;5 Derived Utilities&quot;" data-pltdoc="x">&#19978;&#19968;&#23618;</a>&nbsp;&nbsp;<a href="Speculatively_Atomic_Execution.html" title="前进至&quot;5.9 Speculatively Atomic Execution&quot;" data-pltdoc="x">&#21518;&#19968;&#39029; &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body></html>